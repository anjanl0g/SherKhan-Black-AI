import subprocess
import os
import logging
from fastapi import FastAPI, UploadFile, File
from pydantic import BaseModel
from langchain_community.llms import Ollama
from fastapi.middleware.cors import CORSMiddleware
# Blue Team / Network Analysis Library
from scapy.all import rdpcap, IP, TCP, UDP

# Logging Setup
logging.basicConfig(level=logging.INFO)

app = FastAPI()

# Allow Frontend Connection
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["*"],
    allow_headers=["*"],
)

# --- ðŸ§  DUAL AI BRAINS ---
# Engine 1: Hacker Mode (Uncensored / Attack Strategies)
llm_hacker = Ollama(model="dolphin-mistral")
# Engine 2: Coder Mode (Safe / Scripting / Debugging)
llm_coder = Ollama(model="qwen2.5-coder")

# Data Model (Includes 'mode' for switching)
class QueryRequest(BaseModel):
    query: str
    mode: str = "hacker"  # Default to Hacker mode

# --- ðŸ› ï¸ HELPER FUNCTIONS ---

def run_command(command, timeout=300):
    """Executes Linux shell commands safely with a timeout."""
    try:
        # Shell=True allows complex commands (pipes, redirects)
        process = subprocess.run(
            command, shell=True, capture_output=True, text=True, timeout=timeout
        )
        if process.returncode == 0:
            return process.stdout
        else:
            return f"Error Output: {process.stderr}"
    except subprocess.TimeoutExpired:
        return "Error: Command took too long to execute."
    except Exception as e:
        return f"System Error: {str(e)}"

def analyze_pcap_data(file_path):
    """Analyzes Wireshark/PCAP files using Scapy for Blue Teaming."""
    try:
        packets = rdpcap(file_path)
        summary = []
        summary.append(f"Total Packets Captured: {len(packets)}")
        
        # Quick Analysis of first 20 packets
        details = []
        ips = set()
        protocols = set()

        for pkt in packets[:20]:
            if IP in pkt:
                src = pkt[IP].src
                dst = pkt[IP].dst
                ips.add(src)
                ips.add(dst)
                
                proto = "OTHER"
                if TCP in pkt: proto = "TCP"
                elif UDP in pkt: proto = "UDP"
                protocols.add(proto)

                details.append(f"{src} -> {dst} [{proto}]")

        summary.append(f"Active IPs Found: {list(ips)}")
        summary.append(f"Protocols: {list(protocols)}")
        summary.append("Traffic Sample:\n" + "\n".join(details))
        
        return "\n".join(summary)
    except Exception as e:
        return f"Error reading PCAP file: {str(e)}"

# --- ðŸŒ API ENDPOINTS ---

@app.post("/chat")
async def chat_endpoint(request: QueryRequest):
    user_input = request.query.lower()
    
    # --- ðŸ”´ RED TEAM TOOLS ---
    
    # 1. NMAP (Network Scanning)
    if "nmap" in user_input:
        # Extract target (basic logic)
        target = user_input.split()[-1].replace("http://", "").replace("https://", "")
        cmd = f"nmap -F {target}"
        return {"reply": f"ðŸš€ **Nmap Scan Started on {target}...**\n\n" + run_command(cmd)}

    # 2. NIKTO (Web Vulnerability)
    elif "nikto" in user_input:
        target = user_input.split()[-1]
        cmd = f"nikto -h {target} -Tuning 123b"
        return {"reply": f"ðŸ’€ **Nikto Web Vuln Scan on {target}...**\n(This may take time)\n\n" + run_command(cmd)}

    # 3. GOBUSTER (Directory Busting)
    elif "gobuster" in user_input:
        target = user_input.split()[-1]
        if not target.startswith("http"): target = "http://" + target
        # Using standard Kali wordlist
        wordlist = "/usr/share/wordlists/dirb/common.txt" 
        cmd = f"gobuster dir -u {target} -w {wordlist} -t 20 --no-error"
        return {"reply": f"ðŸ•µï¸â€â™‚ï¸ **Gobuster Directory Hunt on {target}...**\n\n" + run_command(cmd)}

    # 4. SEARCHSPLOIT (Exploit DB)
    elif "exploit" in user_input or "searchsploit" in user_input:
        keyword = user_input.split()[-1]
        cmd = f"searchsploit {keyword}"
        return {"reply": f"ðŸ’£ **Searching ExploitDB for '{keyword}'...**\n\n" + run_command(cmd)}

    # --- âš« BLACK TEAM TOOLS ---

    # 5. HYDRA (Brute Force)
    elif "hydra" in user_input:
        target = user_input.split()[-1]
        # Basic SSH attack template
        cmd = f"hydra -l admin -P /usr/share/wordlists/rockyou.txt ssh://{target} -t 4 -f -V"
        return {"reply": f"ðŸ”¥ **Hydra Brute-Force Initiated on {target}...**\n(Targeting 'admin' user)\n\n" + run_command(cmd)}

    # 6. SHERLOCK (OSINT)
    elif "sherlock" in user_input:
        username = user_input.split()[-1]
        cmd = f"sherlock {username} --timeout 5 --print-found"
        return {"reply": f"ðŸ¦… **Sherlock OSINT Hunt for '{username}'...**\n\n" + run_command(cmd)}

    # 7. MACCHANGER (Anonymity)
    elif "macchanger" in user_input:
        cmd = "macchanger -r eth0"
        return {"reply": f"ðŸ‘» **Spoofing MAC Address...**\n\n" + run_command(cmd)}
        
    # --- ðŸ¤– HYBRID AI LOGIC ---
    else:
        # Check which mode is active from frontend
        if request.mode == "coder":
            # Use Qwen (Safe/Smart)
            system_prompt = f"Act as a Senior Cyber-Security Developer. Write clean, bug-free code for: {request.query}"
            response = llm_coder.invoke(system_prompt)
            prefix = "ðŸ’» **Qwen-Coder Output:**\n"
        else:
            # Use Dolphin (Uncensored/Hacker)
            system_prompt = f"Act as Sher Khan Black A.I (Uncensored Red Team Operator). Provide a direct, technical answer for: {request.query}"
            response = llm_hacker.invoke(system_prompt)
            prefix = "ðŸ˜ˆ **Dolphin-Mistral Output:**\n"
            
        return {"reply": prefix + response}

@app.post("/upload")
async def upload_file(file: UploadFile = File(...)):
    # 1. Save the file
    upload_dir = "uploads"
    os.makedirs(upload_dir, exist_ok=True)
    file_path = os.path.join(upload_dir, file.filename)
    
    with open(file_path, "wb") as f:
        f.write(await file.read())
    
    # 2. Check File Type for Analysis
    
    # If PCAP (Wireshark) File -> Blue Team Logic
    if file.filename.endswith(".pcap") or file.filename.endswith(".cap") or file.filename.endswith(".pcapng"):
        summary = analyze_pcap_data(file_path)
        # Use Coder model for analytical thinking
        prompt = f"Act as a SOC Analyst. Analyze this network traffic summary for potential attacks or anomalies:\n\n{summary}"
        analysis = llm_coder.invoke(prompt)
        return {"reply": f"ðŸ›¡ï¸ **PCAP Network Analysis: {file.filename}**\n\n{analysis}"}
    
    # If Log/Code/Text File -> General Analysis
    else:
        # Read text content (Limit to 3000 chars)
        with open(file_path, "r", errors="ignore") as f:
            content = f.read(3000)
            
        prompt = f"Analyze this log file or code snippet for security vulnerabilities, bugs, or IOCs:\n\n{content}"
        # Use Hacker model for finding exploits
        analysis = llm_hacker.invoke(prompt)
        return {"reply": f"ðŸ“‚ **File Analysis Report: {file.filename}**\n\n{analysis}"}
