"use client";
import React, { useState, useRef, useEffect } from "react";
import { 
  Terminal, Shield, FileCode, Lock, Bug, Search, Ghost, Activity, 
  FileText, Skull, Wifi, Database, Zap, ClipboardCheck, FileSignature, 
  Scale, LayoutDashboard, Flame, ScanFace, Smartphone, Laptop, Upload,
  Eye, Mic, Bot, BrainCircuit, Square, AlertTriangle, X
} from "lucide-react";

export default function PentestDashboard() {
  const [query, setQuery] = useState("");
  // AI Mode State: Hacker (Red), Coder (Blue), or Swarm (Gold)
  const [aiMode, setAiMode] = useState<"hacker" | "coder">("hacker");
  const [swarmMode, setSwarmMode] = useState(false); // NEW: Swarm Toggle

  // --- NEW: ALERTS STATE (For Ghost Protocol) ---
  const [alerts, setAlerts] = useState<{ time: string; ip: string; payload: string }[]>([]);

  const [logs, setLogs] = useState<{ role: string; content: string; timestamp: string }[]>([
    { role: "system", content: "Sher Khan Hybrid Engine Loaded...", timestamp: "BOOT" },
    { role: "system", content: "Dual Core Active: Dolphin-Mistral (Hacker) + Qwen-Coder (Dev)", timestamp: "SYSTEM" },
    { role: "system", content: "MITRE ATT&CK Matrix Loaded.", timestamp: "READY" },
  ]);
  
  const [isProcessing, setIsProcessing] = useState(false);
  const [isRecording, setIsRecording] = useState(false); // NEW: Live Mic State

  const logsEndRef = useRef<HTMLDivElement>(null);
  
  // Refs for file inputs
  const fileInputRef = useRef<HTMLInputElement>(null);
  const visionInputRef = useRef<HTMLInputElement>(null); 
  const mediaRecorderRef = useRef<MediaRecorder | null>(null); // NEW: Audio Recorder

  // Auto-scroll to bottom of logs
  useEffect(() => {
    logsEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [logs]);

  const getCurrentTime = () => new Date().toLocaleTimeString();

  // --- 1. NEW: POLL FOR GHOST ALERTS (Every 3 seconds) ---
  useEffect(() => {
    const interval = setInterval(async () => {
        try {
            const res = await fetch("http://localhost:8000/get-alerts");
            const data = await res.json();
            if (data.alerts && data.alerts.length > 0) {
                setAlerts((prev) => [...data.alerts, ...prev]); 
                // Play Siren Sound (Optional)
                // const audio = new Audio("/alert.mp3"); audio.play().catch(()=>{}); 
            }
        } catch (e) {}
    }, 3000);
    return () => clearInterval(interval);
  }, []);

  // --- 2. NEW: LIVE MIC LOGIC (Browser Native) ---
  const toggleRecording = async () => {
    if (isRecording) {
        // STOP RECORDING
        mediaRecorderRef.current?.stop();
        setIsRecording(false);
    } else {
        // START RECORDING
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const mediaRecorder = new MediaRecorder(stream);
            mediaRecorderRef.current = mediaRecorder;
            
            const audioChunks: Blob[] = [];
            mediaRecorder.ondataavailable = (event) => audioChunks.push(event.data);
            
            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
                const file = new File([audioBlob], "live_command.wav", { type: "audio/wav" });
                handleVoiceUpload(file); // Send to Backend
            };
            
            mediaRecorder.start();
            setIsRecording(true);
            setLogs(prev => [...prev, { role: "system", content: "üéôÔ∏è Listening... (Speak now)", timestamp: getCurrentTime() }]);
        } catch (err) {
            alert("Microphone permission denied. Ensure you are using localhost or HTTPS.");
        }
    }
  };

  const handleVoiceUpload = async (file: File) => {
    setIsProcessing(true);
    const formData = new FormData();
    formData.append("file", file);

    try {
      const response = await fetch("http://localhost:8000/voice-command", {
        method: "POST",
        body: formData,
      });
      const data = await response.json();
      
      // Play Audio Reply
      if (data.audio_url) {
        const audio = new Audio("http://localhost:8000/" + data.audio_url);
        audio.play().catch(e => console.log("Auto-play blocked", e));
      }

      setLogs((prev) => [...prev, { role: "ai", content: `üó£Ô∏è Heard: "${data.transcription}"\nüí° Reply: ${data.reply_text}`, timestamp: getCurrentTime() }]);
    } catch (error) {
      setLogs((prev) => [...prev, { role: "error", content: "‚ùå VOICE ERROR: Check Backend.", timestamp: getCurrentTime() }]);
    } finally {
      setIsProcessing(false);
    }
  };

  // --- COMMAND EXECUTION LOGIC ---
  const executeCommand = async (customCmd?: string) => {
    const finalQuery = customCmd || query;
    if (!finalQuery) return;

    // Determine Mode
    let currentMode = aiMode;
    if (swarmMode) currentMode = "swarm" as any;

    const userLabel = swarmMode ? "sherkhan@swarm-commander" : `sherkhan@${aiMode}`;
    setLogs((prev) => [...prev, { role: "user", content: `${userLabel}:~$ ${finalQuery}`, timestamp: getCurrentTime() }]);
    setQuery("");
    setIsProcessing(true);

    try {
      const response = await fetch("http://localhost:8000/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query: finalQuery, mode: currentMode }),
      });
      const data = await response.json();
      setLogs((prev) => [...prev, { role: "ai", content: data.reply, timestamp: getCurrentTime() }]);
    } catch (error) {
      setLogs((prev) => [...prev, { role: "error", content: "‚ùå ERROR: Backend unreachable.", timestamp: getCurrentTime() }]);
    } finally {
      setIsProcessing(false);
    }
  };

  // --- GENERIC FILE UPLOAD ---
  const handleGenericUpload = async (e: React.ChangeEvent<HTMLInputElement>, endpoint: string, label: string) => {
    const file = e.target.files?.[0]; if (!file) return;
    setLogs(prev => [...prev, { role: "system", content: `üì§ ${label}: ${file.name}...`, timestamp: getCurrentTime() }]);
    setIsProcessing(true);
    const formData = new FormData();
    formData.append("file", file);
    if(endpoint.includes("vision")) formData.append("prompt", "Analyze this cybersecurity screenshot.");

    try {
        const res = await fetch(`http://localhost:8000/${endpoint}`, { method: "POST", body: formData });
        const data = await res.json();
        setLogs(prev => [...prev, { role: "ai", content: data.reply, timestamp: getCurrentTime() }]);
    } catch (e) { setLogs(prev => [...prev, { role: "error", content: "‚ùå Error.", timestamp: getCurrentTime() }]); }
    finally { setIsProcessing(false); }
  };

  // --- VISION UPLOAD (IMAGE) ---
  const handleVisionUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    setLogs((prev) => [...prev, { role: "system", content: `üëÅÔ∏è Vision Analysis: Scanning ${file.name}...`, timestamp: getCurrentTime() }]);
    setIsProcessing(true);

    const formData = new FormData();
    formData.append("file", file);
    formData.append("prompt", "Analyze this cybersecurity screenshot for threats or anomalies.");

    try {
      const response = await fetch("http://localhost:8000/analyze-vision", {
        method: "POST",
        body: formData,
      });
      const data = await response.json();
      setLogs((prev) => [...prev, { role: "ai", content: data.reply, timestamp: getCurrentTime() }]);
    } catch (error) {
      setLogs((prev) => [...prev, { role: "error", content: "‚ùå VISION ERROR: Is Ollama LLaVA model running?", timestamp: getCurrentTime() }]);
    } finally {
      setIsProcessing(false);
    }
  };

  // --- BUTTON COMPONENT ---
  const ToolBtn = ({ icon: Icon, label, cmd, color }: { icon: any, label: string, cmd: string, color: string }) => (
    <button 
        onClick={() => executeCommand(cmd)}
        className="w-full text-left p-2.5 mb-1.5 bg-gray-900/40 hover:bg-green-900/20 border border-white/5 hover:border-green-500/50 rounded flex items-center gap-3 transition-all text-xs font-mono group"
    >
      <Icon size={16} className={`${color} group-hover:drop-shadow-[0_0_8px_rgba(34,197,94,0.6)] transition-all`} />
      <span className="text-gray-400 group-hover:text-white transition-colors">{label}</span>
    </button>
  );

  return (
    <div className="flex h-screen bg-black text-green-500 font-mono overflow-hidden relative">
      
      {/* üö® GHOST PROTOCOL ALERT BANNER (Shows only when Alert exists) */}
      {alerts.length > 0 && (
        <div className="absolute top-4 left-1/2 transform -translate-x-1/2 z-50 w-3/4 max-w-2xl bg-red-900/90 border-2 border-red-500 text-white p-4 rounded shadow-[0_0_30px_rgba(255,0,0,0.6)] animate-bounce-slow">
            <div className="flex justify-between items-center mb-2">
                <div className="flex items-center gap-2 font-bold text-lg">
                    <AlertTriangle className="animate-pulse" /> INTRUSION DETECTED (Ghost Protocol)
                </div>
                <button onClick={() => setAlerts([])}><X size={20}/></button>
            </div>
            {alerts.slice(0, 2).map((a, i) => (
                <div key={i} className="text-xs font-mono bg-black/50 p-2 rounded mb-1">
                    [{a.time}] Source: {a.ip} | Payload: <span className="text-yellow-400">{a.payload}</span>
                </div>
            ))}
        </div>
      )}

      {/* --- SIDEBAR --- */}
      <div className="w-72 border-r border-green-900 bg-black/80 flex flex-col p-4 backdrop-blur-md justify-between z-20 shadow-[0_0_20px_rgba(0,50,0,0.3)] hidden md:flex">
        <div className="overflow-y-auto scrollbar-thin scrollbar-thumb-green-900 pr-2 h-full">
            {/* Header */}
            <div className="flex items-center gap-2 mb-4 text-xl font-bold text-white tracking-widest sticky top-0 bg-black/50 backdrop-blur pb-2 z-10 border-b border-green-900/30">
                <Shield className="w-6 h-6 text-green-500 animate-pulse" />
                <span>BLACK<span className="text-green-600">.AI</span></span>
            </div>

            {/* ü§ñ NEW: SWARM TOGGLE */}
            <div className={`mb-4 p-3 border rounded transition-all cursor-pointer ${swarmMode ? "border-red-500 bg-red-900/20" : "border-gray-700 bg-gray-900/30"}`}
                 onClick={() => setSwarmMode(!swarmMode)}>
                <div className="flex items-center justify-between">
                    <span className={`text-xs font-bold uppercase ${swarmMode ? "text-red-400" : "text-gray-400"}`}>
                        {swarmMode ? "üî• SWARM ACTIVE" : "‚ö´ Swarm Inactive"}
                    </span>
                    <Bot size={16} className={swarmMode ? "text-red-500 animate-bounce" : "text-gray-600"} />
                </div>
                <div className="text-[10px] text-gray-500 mt-1 leading-tight">
                    {swarmMode ? "Running: Hunter + Researcher + Writer Agents" : "Standard Single Agent Mode"}
                </div>
            </div>

            {/* üåü COMMAND CENTER */}
            <div className="text-[10px] text-yellow-500 mb-2 mt-2 uppercase font-bold tracking-wider flex justify-between">
                <span>Command Center</span> <LayoutDashboard size={12}/>
            </div>
            <nav className="space-y-0.5 mb-4">
                <ToolBtn icon={Zap} label="Full Auto Pentest" cmd="Run a full automated penetration test on localhost" color="text-yellow-500" />
                <ToolBtn icon={Activity} label="System Health Check" cmd="Analyze system health" color="text-yellow-500" />
                <ToolBtn icon={FileText} label="Generate Full Report" cmd="Generate a professional security report" color="text-yellow-500" />
            </nav>
            
            {/* üî¥ RED TEAM */}
            <div className="text-[10px] text-red-500 mb-2 mt-4 uppercase font-bold tracking-wider flex justify-between">
                <span>Red Team (Offense)</span> <Search size={12}/>
            </div>
            <nav className="space-y-0.5">
                <ToolBtn icon={Terminal} label="Nmap Scanner" cmd="nmap localhost" color="text-red-500" />
                <ToolBtn icon={Ghost} label="Nikto Vuln Scan" cmd="nikto localhost" color="text-red-500" />
                <ToolBtn icon={Database} label="Gobuster (Dir)" cmd="gobuster localhost" color="text-red-500" />
                <ToolBtn icon={Bug} label="Exploit Search" cmd="exploit linux" color="text-red-500" />
            </nav>

            {/* ‚ö´ BLACK TEAM */}
            <div className="text-[10px] text-purple-500 mb-2 mt-6 uppercase font-bold tracking-wider flex justify-between">
                <span>Black Team (Ops)</span> <Skull size={12}/>
            </div>
            <nav className="space-y-0.5">
                <ToolBtn icon={Flame} label="Hydra Brute-Force" cmd="hydra localhost" color="text-purple-500" />
                <ToolBtn icon={ScanFace} label="Sherlock OSINT" cmd="sherlock admin" color="text-purple-500" />
                <ToolBtn icon={Smartphone} label="MAC Address Spoof" cmd="macchanger" color="text-purple-500" />
                <ToolBtn icon={FileCode} label="Reverse Shell Gen" cmd="Write a python reverse shell script for 192.168.1.5" color="text-purple-400" />
            </nav>

            {/* üîµ BLUE TEAM */}
            <div className="text-[10px] text-blue-500 mb-2 mt-6 uppercase font-bold tracking-wider flex justify-between">
                <span>Blue Team (Defense)</span> <Shield size={12}/>
            </div>
            <nav className="space-y-0.5">
                <ToolBtn icon={Activity} label="PCAP Analysis" cmd="How to analyze pcap file?" color="text-blue-500" />
                <ToolBtn icon={FileText} label="Gen Snort Rule" cmd="Write a Snort rule to detect SQL Injection" color="text-blue-500" />
            </nav>

            {/* ‚ö™ WHITE TEAM */}
            <div className="text-[10px] text-white mb-2 mt-6 uppercase font-bold tracking-wider flex justify-between">
                <span>White Team (Ethical)</span> <Scale size={12}/>
            </div>
            <nav className="space-y-0.5 pb-10">
                <ToolBtn icon={FileSignature} label="Auth Letter Gen" cmd="Write a Pentest Auth Letter for Client X" color="text-white" />
                <ToolBtn icon={ClipboardCheck} label="Compliance Check" cmd="Check for PCI-DSS compliance requirements" color="text-white" />
            </nav>
        </div>

        {/* User Footer */}
        <div className="border-t border-green-900 pt-4 mt-2 bg-black z-20">
            <div className="flex items-center gap-3 mb-2">
                <div className="w-8 h-8 rounded-full bg-green-900 flex items-center justify-center text-white font-bold border border-green-600 shadow-[0_0_10px_rgba(0,255,0,0.5)]">SK</div>
                <div>
                    <div className="text-xs text-white font-bold">Sher Khan</div>
                    <div className="text-[10px] text-gray-400">Commander | /bin/sherkhan-core</div>
                </div>
            </div>
        </div>
      </div>

      {/* --- MAIN CONSOLE --- */}
      <div className="flex-1 flex flex-col relative bg-black">
        {/* Top Bar */}
        <header className="h-14 border-b border-green-900 flex items-center justify-between px-6 bg-gray-900/30">
            <h2 className="text-sm font-bold flex items-center gap-2 text-gray-300">
                <Lock size={14} className="text-green-500"/> /bin/sherkhan-ai-core
            </h2>

            {/* AI Mode Switcher */}
            <div className="flex bg-gray-900 rounded-full p-1 border border-green-900 shadow-inner">
                <button 
                    onClick={() => { setAiMode("hacker"); setSwarmMode(false); }}
                    className={`flex items-center gap-2 px-4 py-1 rounded-full text-[10px] font-bold transition-all uppercase tracking-wider ${aiMode === 'hacker' && !swarmMode ? 'bg-red-600 text-black shadow-[0_0_15px_rgba(220,38,38,0.6)]' : 'text-gray-500 hover:text-gray-300'}`}
                >
                    <Skull size={12} /> Hacker
                </button>
                <button 
                    onClick={() => { setAiMode("coder"); setSwarmMode(false); }}
                    className={`flex items-center gap-2 px-4 py-1 rounded-full text-[10px] font-bold transition-all uppercase tracking-wider ${aiMode === 'coder' && !swarmMode ? 'bg-blue-600 text-black shadow-[0_0_15px_rgba(37,99,235,0.6)]' : 'text-gray-500 hover:text-gray-300'}`}
                >
                    <Laptop size={12} /> Coder
                </button>
                {/* Visual Indicator for Swarm in Header */}
                {swarmMode && (
                    <button className="flex items-center gap-2 px-4 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider bg-yellow-600 text-black shadow-[0_0_15px_rgba(234,179,8,0.6)] animate-pulse ml-1">
                        <BrainCircuit size={12} /> Swarm
                    </button>
                )}
            </div>

            <div className="flex gap-2 items-center">
                 <Zap size={14} className="text-yellow-500 animate-pulse" />
                <span className="text-[10px] text-yellow-500">SYSTEM: ONLINE</span>
            </div>
        </header>

        {/* Log Output Area */}
        <div className="flex-1 overflow-y-auto p-6 space-y-4 scrollbar-thin scrollbar-thumb-green-900">
          {logs.map((log, index) => (
            <div key={index} className={`p-3 rounded border-l-2 max-w-5xl ${
                log.role === 'user' ? 'border-blue-500 bg-blue-900/10 ml-auto' : 
                log.role === 'error' ? 'border-red-500 text-red-400 bg-red-900/10' :
                'border-green-500 bg-green-900/5 text-green-400'
            }`}>
              <div className="text-[10px] opacity-60 mb-1 uppercase flex justify-between">
                  <span>{log.role}</span>
                  <span className="text-gray-600">{log.timestamp}</span>
              </div>
              <div className="whitespace-pre-wrap leading-relaxed font-mono text-sm">{log.content}</div>
            </div>
          ))}
          {isProcessing && <div className="text-green-500 animate-pulse text-sm">_ AI Engine is Processing...</div>}
          <div ref={logsEndRef} />
        </div>

        {/* Input Area */}
        <div className="p-4 bg-gray-900/80 border-t border-green-900">
            <div className="flex gap-0 border border-green-800 rounded-md overflow-hidden bg-black shadow-[0_0_15px_rgba(0,255,0,0.15)]">
                
                {/* --- HIDDEN INPUTS --- */}
                <input type="file" ref={fileInputRef} onChange={handleGenericUpload} className="hidden" />
                <input type="file" accept="image/*" ref={visionInputRef} onChange={handleVisionUpload} className="hidden" />
                
                {/* --- üëÅÔ∏è VISION BUTTON --- */}
                <button 
                    onClick={() => visionInputRef.current?.click()} 
                    className="px-3 border-r border-green-900 hover:bg-green-900/30 text-gray-400 hover:text-blue-400 transition-colors"
                    title="Vision Analysis (Upload Screenshot)"
                >
                    <Eye size={20} />
                </button>

                {/* --- üéôÔ∏è LIVE MIC BUTTON (UPDATED) --- */}
                <button 
                    onClick={toggleRecording} 
                    className={`px-3 border-r border-green-900 transition-all ${isRecording ? "text-red-500 bg-red-900/20 animate-pulse" : "text-gray-400 hover:text-yellow-400 hover:bg-green-900/30"}`}
                    title={isRecording ? "Click to STOP Recording" : "Click to SPEAK (Live Command)"}
                >
                    {isRecording ? <Square size={20} fill="currentColor" /> : <Mic size={20} />}
                </button>

                {/* --- üì§ UPLOAD BUTTON --- */}
                <button 
                    onClick={() => fileInputRef.current?.click()} 
                    className="px-3 border-r border-green-900 hover:bg-green-900/30 text-gray-400 hover:text-green-400 transition-colors"
                    title="Upload File for Analysis"
                >
                    <Upload size={20} />
                </button>
                
                <span className="bg-transparent text-green-500 px-3 py-4 flex items-center font-bold text-lg">$</span>
                
                <input
                    type="text"
                    value={query}
                    onChange={(e) => setQuery(e.target.value)}
                    onKeyDown={(e) => e.key === "Enter" && executeCommand()}
                    className="flex-1 bg-transparent text-white p-3 outline-none placeholder-gray-600 font-mono"
                    placeholder={swarmMode ? "Commanding Swarm Agents..." : `Enter command for ${aiMode === 'hacker' ? 'Hacker Mode' : 'Coder Mode'}...`}
                    autoFocus
                />
                
                <button 
                    onClick={() => executeCommand()} 
                    className="bg-green-700 hover:bg-green-600 text-black px-8 font-bold hover:shadow-[0_0_15px_rgba(34,197,94,0.5)] transition-all"
                >
                    RUN
                </button>
            </div>
        </div>
      </div>
    </div>
  );
}
