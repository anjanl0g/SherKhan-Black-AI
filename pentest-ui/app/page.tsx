"use client";
import React, { useState, useRef, useEffect } from "react";
import { Terminal, Shield, FileCode, Send, Lock, AlertTriangle, Bug, Search, Ghost, Eye, Activity, FileText, Skull, Wifi, UserX, Database, Zap, ClipboardCheck, FileSignature, Scale, LayoutDashboard, Flame, ScanFace, Smartphone, Laptop } from "lucide-react";

export default function PentestDashboard() {
  const [query, setQuery] = useState("");
  // New State for AI Mode Switcher
  const [aiMode, setAiMode] = useState<"hacker" | "coder">("hacker");

  const [logs, setLogs] = useState([
    { role: "system", content: "Sher Khan Hybrid Engine Loaded...", timestamp: "BOOT" },
    { role: "system", content: "Dual Core Active: Dolphin-Mistral (Hacker) + Qwen-Coder (Dev)", timestamp: "SYSTEM" },
    { role: "system", content: "All Modules (Red/Blue/Black/White) Initialized.", timestamp: "READY" },
  ]);
  
  const [isProcessing, setIsProcessing] = useState(false);
  const logsEndRef = useRef<HTMLDivElement>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);

  useEffect(() => {
    logsEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [logs]);

  const getCurrentTime = () => new Date().toLocaleTimeString();

  const executeCommand = async (customCmd?: string) => {
    const finalQuery = customCmd || query;
    if (!finalQuery) return;

    // Log me dikhayenge ke kaunsa AI use ho raha hai
    const aiUser = aiMode === "hacker" ? "sherkhan@hacker" : "sherkhan@coder";
    setLogs((prev) => [...prev, { role: "user", content: `${aiUser}:~$ ${finalQuery}`, timestamp: getCurrentTime() }]);
    setQuery("");
    setIsProcessing(true);

    try {
      const response = await fetch("http://localhost:8000/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        // Mode bhi bhej rahe hain backend ko
        body: JSON.stringify({ query: finalQuery, mode: aiMode }),
      });
      const data = await response.json();
      setLogs((prev) => [...prev, { role: "ai", content: data.reply, timestamp: getCurrentTime() }]);
    } catch (error) {
      setLogs((prev) => [...prev, { role: "error", content: "ERROR: Backend unreachable.", timestamp: getCurrentTime() }]);
    } finally {
      setIsProcessing(false);
    }
  };

  const handleFileUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    setLogs((prev) => [...prev, { role: "system", content: `ðŸ“¤ Uploading ${file.name} for Deep Analysis...`, timestamp: getCurrentTime() }]);
    setIsProcessing(true);

    const formData = new FormData();
    formData.append("file", file);

    try {
      const response = await fetch("http://localhost:8000/upload", {
        method: "POST",
        body: formData,
      });
      const data = await response.json();
      setLogs((prev) => [...prev, { role: "ai", content: data.reply, timestamp: getCurrentTime() }]);
    } catch (error) {
      setLogs((prev) => [...prev, { role: "error", content: "UPLOAD ERROR: Check Backend.", timestamp: getCurrentTime() }]);
    } finally {
      setIsProcessing(false);
    }
  };

  // Stylish Button Component
  const ToolBtn = ({ icon: Icon, label, cmd, color }: { icon: any, label: string, cmd: string, color: string }) => (
    <button 
        onClick={() => setQuery(cmd)}
        className="w-full text-left p-2.5 mb-1.5 bg-gray-900/40 hover:bg-green-900/20 border border-white/5 hover:border-green-500/50 rounded flex items-center gap-3 transition-all text-xs font-mono group"
    >
      <Icon size={16} className={`${color} group-hover:drop-shadow-[0_0_8px_rgba(34,197,94,0.6)] transition-all`} />
      <span className="text-gray-400 group-hover:text-white transition-colors">{label}</span>
    </button>
  );

  return (
    <div className="flex h-screen bg-black text-green-500 font-mono overflow-hidden">
      
      {/* --- SIDEBAR START (ALL SECTIONS INCLUDED) --- */}
      <div className="w-68 border-r border-green-900 bg-black/80 flex flex-col p-4 backdrop-blur-md justify-between z-20 shadow-[0_0_20px_rgba(0,50,0,0.3)]">
        <div className="overflow-y-auto scrollbar-thin scrollbar-thumb-green-900 pr-2 h-full">
            <div className="flex items-center gap-2 mb-4 text-xl font-bold text-white tracking-widest sticky top-0 bg-black/50 backdrop-blur pb-2 z-10 border-b border-green-900/30">
                <Shield className="w-6 h-6 text-green-500 animate-pulse" />
                <span>BLACK<span className="text-green-600">.AI</span></span>
            </div>

            {/* ðŸŒŸ ALL-IN-ONE */}
            <div className="text-[10px] text-yellow-500 mb-2 mt-2 uppercase font-bold tracking-wider flex justify-between">
                <span>Command Center</span> <LayoutDashboard size={12}/>
            </div>
            <nav className="space-y-0.5 mb-4">
                <ToolBtn icon={Zap} label="Full Auto Pentest" cmd="Run a full automated penetration test on " color="text-yellow-500" />
                <ToolBtn icon={Activity} label="System Health Check" cmd="Analyze system health" color="text-yellow-500" />
                <ToolBtn icon={FileText} label="Generate Full Report" cmd="Generate a professional security report" color="text-yellow-500" />
            </nav>
            
            {/* ðŸ”´ RED TEAM */}
            <div className="text-[10px] text-red-500 mb-2 mt-4 uppercase font-bold tracking-wider flex justify-between">
                <span>Red Team (Offense)</span> <Search size={12}/>
            </div>
            <nav className="space-y-0.5">
                <ToolBtn icon={Terminal} label="Nmap Scanner" cmd="Scan nmap " color="text-red-500" />
                <ToolBtn icon={Ghost} label="Nikto Vuln Scan" cmd="Run nikto on " color="text-red-500" />
                <ToolBtn icon={Database} label="Gobuster (Dir)" cmd="Run gobuster on " color="text-red-500" />
                <ToolBtn icon={Bug} label="Exploit Search" cmd="Search exploit for " color="text-red-500" />
            </nav>

            {/* âš« BLACK TEAM */}
            <div className="text-[10px] text-purple-500 mb-2 mt-6 uppercase font-bold tracking-wider flex justify-between">
                <span>Black Team (Ops)</span> <Skull size={12}/>
            </div>
            <nav className="space-y-0.5">
                <ToolBtn icon={Flame} label="Hydra Brute-Force" cmd="Run hydra on " color="text-purple-500" />
                <ToolBtn icon={ScanFace} label="Sherlock OSINT" cmd="Run sherlock for username: " color="text-purple-500" />
                <ToolBtn icon={Smartphone} label="MAC Address Spoof" cmd="Run macchanger" color="text-purple-500" />
                <ToolBtn icon={FileCode} label="Reverse Shell Gen" cmd="Write a python reverse shell script for " color="text-purple-400" />
                <ToolBtn icon={Wifi} label="C2 Server Logic" cmd="Write a python script for a C2 server" color="text-purple-400" />
            </nav>

            {/* ðŸ”µ BLUE TEAM */}
            <div className="text-[10px] text-blue-500 mb-2 mt-6 uppercase font-bold tracking-wider flex justify-between">
                <span>Blue Team (Defense)</span> <Shield size={12}/>
            </div>
            <nav className="space-y-0.5">
                <ToolBtn icon={Activity} label="PCAP Analysis" cmd="How to analyze pcap file?" color="text-blue-500" />
                <ToolBtn icon={FileText} label="Gen Snort Rule" cmd="Write a Snort rule to detect " color="text-blue-500" />
                <ToolBtn icon={Eye} label="Gen YARA Rule" cmd="Write a YARA rule for " color="text-blue-500" />
            </nav>

            {/* âšª WHITE TEAM */}
            <div className="text-[10px] text-white mb-2 mt-6 uppercase font-bold tracking-wider flex justify-between">
                <span>White Team (Ethical)</span> <Scale size={12}/>
            </div>
            <nav className="space-y-0.5 pb-10">
                <ToolBtn icon={FileSignature} label="Auth Letter Gen" cmd="Write a Pentest Auth Letter for " color="text-white" />
                <ToolBtn icon={ClipboardCheck} label="Compliance Check" cmd="Check for PCI-DSS compliance" color="text-white" />
                <ToolBtn icon={Scale} label="Risk Score Calc" cmd="Calculate CVSS Risk Score for " color="text-white" />
            </nav>

        </div>

        <div className="border-t border-green-900 pt-4 mt-2 bg-black z-20">
            <div className="flex items-center gap-3 mb-2">
                <div className="w-8 h-8 rounded-full bg-green-900 flex items-center justify-center text-white font-bold border border-green-600 shadow-[0_0_10px_rgba(0,255,0,0.5)]">SK</div>
                <div>
                    <div className="text-xs text-white font-bold">Sher Khan</div>
                    <div className="text-[10px] text-gray-400">Commander | /bin/sherkhan-core</div>
                </div>
            </div>
        </div>
      </div>
      {/* --- SIDEBAR END --- */}


      {/* --- MAIN CONSOLE START --- */}
      <div className="flex-1 flex flex-col relative bg-black">
        <header className="h-14 border-b border-green-900 flex items-center justify-between px-6 bg-gray-900/30">
            
            <h2 className="text-sm font-bold flex items-center gap-2 text-gray-300">
                <Lock size={14} className="text-green-500"/> /bin/sherkhan-ai-core
            </h2>

            {/* ðŸ”¥ NEW AI MODE SWITCHER ðŸ”¥ */}
            <div className="flex bg-gray-900 rounded-full p-1 border border-green-900 shadow-inner">
                <button 
                    onClick={() => setAiMode("hacker")}
                    className={`flex items-center gap-2 px-4 py-1 rounded-full text-[10px] font-bold transition-all uppercase tracking-wider ${aiMode === 'hacker' ? 'bg-red-600 text-black shadow-[0_0_15px_rgba(220,38,38,0.6)]' : 'text-gray-500 hover:text-gray-300'}`}
                >
                    <Skull size={12} /> Hacker
                </button>
                <button 
                    onClick={() => setAiMode("coder")}
                    className={`flex items-center gap-2 px-4 py-1 rounded-full text-[10px] font-bold transition-all uppercase tracking-wider ${aiMode === 'coder' ? 'bg-blue-600 text-black shadow-[0_0_15px_rgba(37,99,235,0.6)]' : 'text-gray-500 hover:text-gray-300'}`}
                >
                    <Laptop size={12} /> Coder
                </button>
            </div>

            <div className="flex gap-2 items-center">
                 <Zap size={14} className="text-yellow-500 animate-pulse" />
                <span className="text-[10px] text-yellow-500">SYSTEM: ONLINE</span>
            </div>
        </header>

        {/* OUTPUT */}
        <div className="flex-1 overflow-y-auto p-6 space-y-4 scrollbar-thin scrollbar-thumb-green-900">
          {logs.map((log, index) => (
            <div key={index} className={`p-3 rounded border-l-2 max-w-5xl ${
                log.role === 'user' ? 'border-blue-500 bg-blue-900/10 ml-auto' : 
                log.role === 'error' ? 'border-red-500 text-red-400 bg-red-900/10' :
                'border-green-500 bg-green-900/5 text-green-400'
            }`}>
              <div className="text-[10px] opacity-60 mb-1 uppercase flex justify-between">
                  <span>{log.role}</span>
                  <span className="text-gray-600">{log.timestamp}</span>
              </div>
              <div className="whitespace-pre-wrap leading-relaxed">{log.content}</div>
            </div>
          ))}
          {isProcessing && <div className="text-green-500 animate-pulse">_ AI Engine is Processing...</div>}
          <div ref={logsEndRef} />
        </div>

        {/* INPUT */}
        <div className="p-4 bg-gray-900/80 border-t border-green-900">
            <div className="flex gap-0 border border-green-800 rounded-md overflow-hidden bg-black shadow-[0_0_15px_rgba(0,255,0,0.15)]">
                <input type="file" ref={fileInputRef} onChange={handleFileUpload} className="hidden" />
                <button onClick={() => fileInputRef.current?.click()} className="px-4 border-r border-green-900 hover:bg-green-900/30 text-gray-400 hover:text-green-400 transition-colors">
                    <FileCode size={20} />
                </button>
                <span className="bg-transparent text-green-500 px-3 py-4 flex items-center font-bold text-lg">$</span>
                <input
                    type="text"
                    value={query}
                    onChange={(e) => setQuery(e.target.value)}
                    onKeyDown={(e) => e.key === "Enter" && executeCommand()}
                    className="flex-1 bg-transparent text-white p-3 outline-none placeholder-gray-600"
                    placeholder={`Enter command for ${aiMode === 'hacker' ? 'Uncensored Mode (Attack)' : 'Safe Mode (Coding)'}...`}
                    autoFocus
                />
                <button onClick={() => executeCommand()} className="bg-green-700 hover:bg-green-600 text-black px-8 font-bold hover:shadow-[0_0_15px_rgba(34,197,94,0.5)] transition-all">RUN</button>
            </div>
        </div>
      </div>
    </div>
  );
}
