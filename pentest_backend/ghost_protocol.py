import socket
import logging
import threading
import time
import sqlite3
import datetime

# --- GHOST LOGGING ---
logging.basicConfig(
    filename='ghost_logs.txt', 
    level=logging.INFO, 
    format='%(asctime)s - [GHOST PROTOCOL] - %(message)s'
)

DB_NAME = "sherkhan.db"

class GhostProtocol:
    def __init__(self, port=2222):
        self.port = port
        self.is_running = False

    def log_attack_to_db(self, ip, payload):
        """Save intrusion directly to Database for UI Alert"""
        try:
            conn = sqlite3.connect(DB_NAME)
            c = conn.cursor()
            # Ensure table exists (Alerts Table)
            c.execute('''CREATE TABLE IF NOT EXISTS alerts
                         (id INTEGER PRIMARY KEY, timestamp TEXT, ip TEXT, payload TEXT, status TEXT)''')
            
            c.execute("INSERT INTO alerts (timestamp, ip, payload, status) VALUES (?, ?, ?, ?)",
                      (datetime.datetime.now().strftime("%H:%M:%S"), ip, payload, "UNREAD"))
            conn.commit()
            conn.close()
        except Exception as e:
            print(f"‚ùå DB Error in Ghost Protocol: {e}")

    def handle_attacker(self, client_socket, addr):
        ip = addr[0]
        logging.info(f"üö® ALERT: Intrusion Detected from {ip}")
        print(f"\nüëª [GHOST TRAP] üö® INTRUSION DETECTED: {ip}")
        
        # Log Initial Connection
        self.log_attack_to_db(ip, "Connection Attempt")

        try:
            # Fake SSH Banner
            client_socket.send(b"SSH-2.0-OpenSSH_8.2p1 Ubuntu-4ubuntu0.5\r\n")
            client_socket.settimeout(10)
            data = client_socket.recv(1024)
            
            if data:
                captured_payload = data.decode('utf-8', errors='ignore').strip()
                logging.info(f"üì∏ CAPTURED PAYLOAD from {ip}: {captured_payload}")
                print(f"üì∏ [GHOST] Stole Credentials: {captured_payload}")
                
                # Update DB with payload
                self.log_attack_to_db(ip, f"Creds: {captured_payload}")
            
            time.sleep(2) 
            client_socket.send(b"Access denied (publickey,password).\n")
            
        except Exception as e:
            logging.error(f"Error handling attacker: {e}")
        finally:
            client_socket.close()

    def start_server(self):
        server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        
        try:
            server.bind(("0.0.0.0", self.port))
            server.listen(5)
            self.is_running = True
            print(f"‚úÖ GHOST PROTOCOL ACTIVE on Port {self.port}")
            
            while self.is_running:
                client, addr = server.accept()
                t = threading.Thread(target=self.handle_attacker, args=(client, addr))
                t.daemon = True
                t.start()
                
        except Exception as e:
            print(f"‚ùå Ghost Protocol Start Failed: {e}")
